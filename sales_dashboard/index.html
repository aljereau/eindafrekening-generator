<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RyanRent Sales Dashboard</title>
    <style>
        :root {
            --primary: #2ba306;
            --primary-light: #f6f2e0;
            --success: #228B22;
            --warning: #FF8C00;
            --danger: #DC3545;
            --gray: #6c757d;
            --light: #f8f9fa;
            --white: #ffffff;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Barlow, sans-serif;
            background: linear-gradient(135deg, #f6f2e0 0%, #e8e4d3 100%);
            min-height: 100vh;
            color: #333;
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, #1a5f2a 100%);
            color: white;
            padding: 0.75rem 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        header .brand {
            display: flex;
            flex-direction: column;
        }

        header h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        header .subtitle {
            opacity: 0.8;
            font-size: 0.75rem;
        }

        header .header-kpis {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        header .header-kpi {
            text-align: center;
            min-width: 70px;
        }

        header .header-kpi .value {
            font-size: 1.4rem;
            font-weight: 700;
        }

        header .header-kpi .value.money {
            color: #90EE90;
        }

        header .header-kpi .label {
            font-size: 0.65rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* KPI Cards - now hidden, using header version */
        .kpi-grid {
            display: none;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.6rem 1.25rem;
            background: var(--white);
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray);
            box-shadow: var(--shadow);
        }

        .tab:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        /* Search & Filters */
        .toolbar {
            background: var(--white);
            border-radius: var(--radius);
            padding: 0.75rem 1rem;
            box-shadow: var(--shadow);
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: var(--radius);
            font-size: 0.9rem;
        }

        .toolbar input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .toolbar select {
            padding: 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: var(--radius);
            font-size: 0.9rem;
        }

        .toolbar .btn {
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.85rem;
        }

        .toolbar .btn:hover {
            background: #163d5f;
        }

        /* Panels */
        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* Data Table */
        .data-table-wrapper {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .data-table th {
            background: var(--primary);
            color: white;
            padding: 0.6rem 0.75rem;
            text-align: left;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }

        .data-table th:hover {
            background: #163d5f;
        }

        .data-table th .sort-icon {
            margin-left: 0.25rem;
            opacity: 0.7;
        }

        .data-table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #eee;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .data-table tr:hover td {
            background: var(--primary-light);
        }

        .data-table tr {
            cursor: pointer;
        }

        .data-table .money {
            font-weight: 500;
        }

        .data-table .money.positive {
            color: var(--success);
        }

        .data-table .money.negative {
            color: var(--danger);
        }

        .data-table .status-badge {
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.available {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.rented {
            background: #cce5ff;
            color: #004085;
        }

        .status-badge.leegstand {
            background: #fff3cd;
            color: #856404;
        }

        /* Card Layout CSS */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }

        .view-toggle button {
            background: #e0e0e0;
            border: none;
            padding: 0.4rem 0.75rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 1rem;
        }

        .view-toggle button.active {
            background: var(--primary);
            color: white;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            max-height: 600px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .property-card {
            background: white;
            border-radius: var(--radius);
            padding: 1rem;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid var(--gray);
        }

        .property-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .property-card.status-beschikbaar {
            border-left-color: var(--success);
        }

        .property-card.status-verhuurd {
            border-left-color: #2196F3;
        }

        .property-card.status-leegstand {
            border-left-color: var(--warning);
        }

        .property-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .property-card .card-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #333;
        }

        .property-card .card-subtitle {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .property-card .card-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .property-card .card-item {
            display: flex;
            flex-direction: column;
        }

        .property-card .card-label {
            font-size: 0.7rem;
            color: var(--gray);
            text-transform: uppercase;
        }

        .property-card .card-value {
            font-weight: 500;
        }

        .property-card .card-value.money {
            color: var(--success);
        }

        .property-card .card-value.warning {
            color: var(--warning);
        }

        .property-card .marge-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 0.75rem;
            overflow: hidden;
        }

        .property-card .marge-bar .fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* Countdown badge for Binnenkort vrij */
        .countdown-badge {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            font-weight: 700;
            font-size: 0.9rem;
            text-align: center;
            min-width: 50px;
        }

        .countdown-badge.urgent {
            background: linear-gradient(135deg, #dc3545, #ff6b6b);
        }

        .countdown-badge.soon {
            background: linear-gradient(135deg, #FF8C00, #ffa726);
        }

        .countdown-badge.later {
            background: linear-gradient(135deg, #28a745, #4caf50);
        }

        /* Contact card */
        .contact-card {
            background: white;
            border-radius: var(--radius);
            padding: 1rem;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .contact-card:hover {
            transform: translateY(-2px);
        }

        .contact-card .card-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .contact-card .card-stats {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .contact-card .card-contact {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .contact-card .card-contact a {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: #f0f0f0;
            border-radius: var(--radius);
            color: var(--gray);
            text-decoration: none;
            font-size: 0.8rem;
        }

        .contact-card .card-contact a:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .status-badge.badge-danger {
            background: #f8d7da;
            color: #721c24;
            font-weight: 600;
        }

        .status-badge.badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Detail Panel (side panel) */
        .detail-panel {
            position: fixed;
            top: 0;
            right: -500px;
            width: 480px;
            height: 100vh;
            background: var(--white);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .detail-panel.open {
            right: 0;
        }

        .detail-panel-header {
            background: var(--primary);
            color: white;
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }

        .detail-panel-header h2 {
            font-size: 1.1rem;
        }

        .detail-panel-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .detail-panel-body {
            padding: 1rem;
        }

        .detail-section {
            margin-bottom: 1.25rem;
        }

        .detail-section h3 {
            color: var(--primary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.35rem 0.75rem;
            font-size: 0.85rem;
        }

        .detail-item {
            display: flex;
            gap: 0.5rem;
        }

        .detail-item .label {
            color: var(--gray);
            min-width: 80px;
        }

        .detail-item .value {
            font-weight: 500;
        }

        .detail-item .value.money {
            color: var(--success);
        }

        .detail-item .value a {
            color: var(--primary);
        }

        /* Property mini-cards in detail panel */
        .property-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .property-mini {
            background: var(--light);
            border-radius: var(--radius);
            padding: 0.6rem 0.75rem;
            border-left: 3px solid var(--primary);
            cursor: pointer;
            font-size: 0.85rem;
        }

        .property-mini:hover {
            background: var(--primary-light);
        }

        .property-mini .addr {
            font-weight: 500;
            color: var(--primary);
        }

        .property-mini .meta {
            color: var(--gray);
            font-size: 0.8rem;
            margin-top: 0.2rem;
        }

        /* Results count */
        .results-info {
            color: var(--gray);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        /* Overlay for panel */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
        }

        .overlay.active {
            display: block;
        }

        /* Print */
        /* Sales Prep */
        .sales-prep {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .calc-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: var(--shadow);
        }

        .calc-card h3 {
            color: var(--primary);
            font-size: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .calc-row .label {
            color: var(--gray);
        }

        .calc-row .value {
            font-weight: 600;
        }

        .calc-row .value.positive {
            color: var(--success);
        }

        .calc-row .value.negative {
            color: var(--danger);
        }

        .calc-input {
            width: 100px;
            padding: 0.4rem;
            border: 2px solid #e0e0e0;
            border-radius: var(--radius);
            text-align: right;
            font-size: 0.9rem;
        }

        .calc-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .margin-bar {
            height: 20px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .margin-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #2ed573);
            transition: width 0.3s;
        }

        .toggle-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .toggle-btn {
            padding: 0.35rem 0.75rem;
            background: var(--light);
            border: 2px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .toggle-btn.active {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        /* Searchable Dropdown */
        .search-select {
            position: relative;
            width: 100%;
        }

        .search-select input {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: var(--radius);
            font-size: 0.95rem;
        }

        .search-select input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-select .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 2px solid var(--primary);
            border-radius: var(--radius);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .search-select .dropdown.open {
            display: block;
        }

        .search-select .dropdown-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.85rem;
            border-bottom: 1px solid #eee;
        }

        .search-select .dropdown-item:hover {
            background: var(--primary-light);
        }

        .search-select .dropdown-item.selected {
            background: var(--primary);
            color: white;
        }

        .search-select .dropdown-item .pppw {
            float: right;
            font-weight: 600;
            color: var(--success);
        }

        .search-select .dropdown-item:hover .pppw {
            color: var(--primary);
        }

        /* Client Matcher */
        .matcher-results {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 0.75rem;
        }

        .matcher-item {
            background: var(--light);
            border-radius: var(--radius);
            padding: 0.6rem 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            border-left: 3px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .matcher-item:hover {
            background: var(--primary-light);
        }

        .matcher-item.in-budget {
            border-left-color: var(--success);
            background: #d4edda;
        }

        .matcher-item .info {
            flex: 1;
        }

        .matcher-item .addr {
            font-weight: 500;
            color: var(--primary);
        }

        .matcher-item .meta {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .matcher-item .pppw-badge {
            font-weight: 700;
            font-size: 1rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            background: var(--white);
        }

        .matcher-item.in-budget .pppw-badge {
            background: var(--success);
            color: white;
        }

        .budget-inputs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .budget-inputs input {
            flex: 1;
            padding: 0.4rem;
            border: 2px solid #e0e0e0;
            border-radius: var(--radius);
            font-size: 0.9rem;
        }

        .budget-inputs input:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* Back button */
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 0.75rem;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @media print {
            body>*:not(.detail-panel) {
                display: none !important;
            }

            .detail-panel {
                position: static !important;
                width: 100% !important;
                box-shadow: none !important;
            }

            .detail-panel-close,
            .btn {
                display: none !important;
            }
        }

        @media (max-width: 1200px) {
            .kpi-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .sales-prep {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .detail-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="brand">
            <h1>ğŸ  RyanRent Sales Dashboard</h1>
            <div class="subtitle" id="lastUpdate">Laden...</div>
        </div>
        <div class="header-kpis">
            <div class="header-kpi">
                <div class="value" id="kpiTotal">-</div>
                <div class="label">Woningen</div>
            </div>
            <div class="header-kpi">
                <div class="value" id="kpiAvailable">-</div>
                <div class="label">Vrij</div>
            </div>
            <div class="header-kpi">
                <div class="value" id="kpiRented">-</div>
                <div class="label">Verhuurd</div>
            </div>
            <div class="header-kpi">
                <div class="value money" id="kpiMarge">-</div>
                <div class="label">Marge/m</div>
            </div>
            <div class="header-kpi">
                <div class="value money" id="kpiMargeJaar">-</div>
                <div class="label">Marge/j</div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- KPIs -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="value" id="kpiTotal">-</div>
                <div class="label">Woningen</div>
            </div>
            <div class="kpi-card">
                <div class="value" id="kpiAvailable">-</div>
                <div class="label">Beschikbaar</div>
            </div>
            <div class="kpi-card">
                <div class="value" id="kpiRented">-</div>
                <div class="label">Verhuurd</div>
            </div>
            <div class="kpi-card">
                <div class="value" id="kpiLeegstand">-</div>
                <div class="label">Leegstand</div>
            </div>
            <div class="kpi-card">
                <div class="value money" id="kpiMarge">-</div>
                <div class="label">Marge/Maand</div>
            </div>
            <div class="kpi-card">
                <div class="value money" id="kpiMargeJaar">-</div>
                <div class="label">Marge/Jaar</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="woningen">ğŸ  Woningen</button>
            <button class="tab" data-tab="binnenkort">ğŸ“… Binnenkort Vrij</button>
            <button class="tab" data-tab="eigenaren">ğŸ‘¤ Eigenaren</button>
            <button class="tab" data-tab="huurders">ğŸ‘¥ Huurders</button>
            <button class="tab" data-tab="financieel">ğŸ’° Financieel</button>
            <button class="tab" data-tab="relaties"
                style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">ğŸ“‡ Relaties Zoeken</button>
            <button class="tab" data-tab="salesprep"
                style="background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white;">ğŸ¯ Sales Prep</button>
        </div>

        <!-- Woningen Panel -->
        <div class="panel active" id="panel-woningen">
            <div class="toolbar">
                <input type="text" id="searchWoningen" placeholder="ğŸ” Zoek adres, eigenaar, huurder, plaats...">
                <select id="filterStatus">
                    <option value="">Alle status</option>
                    <option value="Beschikbaar">Beschikbaar</option>
                    <option value="Verhuurd">Verhuurd</option>
                    <option value="Leegstand">Leegstand</option>
                </select>
                <select id="filterStad">
                    <option value="">Alle steden</option>
                </select>
                <div class="view-toggle">
                    <button id="viewTableWoningen" title="Tabel">ğŸ“‹</button>
                    <button id="viewCardsWoningen" class="active" title="Kaarten">ğŸƒ</button>
                </div>
            </div>
            <div class="results-info"><span id="resultsCount"></span></div>
            <div id="woningenTableView" class="data-table-wrapper"
                style="max-height: 600px; overflow-y: auto; display:none;">
                <table class="data-table" id="woningenTable">
                    <thead>
                        <tr>
                            <th data-sort="object_id">Object</th>
                            <th data-sort="adres">Adres</th>
                            <th data-sort="plaats">Plaats</th>
                            <th data-sort="eigenaar_naam">Eigenaar</th>
                            <th data-sort="huurder_naam">Huurder</th>
                            <th data-sort="marge_maand_excl_btw">Marge</th>
                            <th data-sort="beschikbaarheid_status">Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="woningenCardsView" class="cards-grid"></div>
        </div>

        <!-- Binnenkort Beschikbaar Panel -->
        <div class="panel" id="panel-binnenkort">
            <div class="toolbar">
                <select id="filterBinnenkortDays" style="min-width:150px;">
                    <option value="30">Binnen 30 dagen</option>
                    <option value="60">Binnen 60 dagen</option>
                    <option value="90" selected>Binnen 90 dagen</option>
                    <option value="180">Binnen 6 maanden</option>
                </select>
                <input type="text" id="searchBinnenkort" placeholder="ğŸ” Zoek adres, huurder...">
                <div class="view-toggle">
                    <button id="viewTableBinnenkort" title="Tabel">ğŸ“‹</button>
                    <button id="viewCardsBinnenkort" class="active" title="Kaarten">ğŸƒ</button>
                </div>
            </div>
            <div class="results-info"><span id="binnenkortCount"></span></div>
            <div id="binnenkortTableView" class="data-table-wrapper"
                style="max-height: 600px; overflow-y: auto; display:none;">
                <table class="data-table" id="binnenkortTable">
                    <thead>
                        <tr>
                            <th>Object</th>
                            <th>Adres</th>
                            <th>Plaats</th>
                            <th>Huurder</th>
                            <th>Einddatum</th>
                            <th>Dagen</th>
                            <th>Marge</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="binnenkortCardsView" class="cards-grid"></div>
        </div>

        <!-- Eigenaren Panel -->
        <div class="panel" id="panel-eigenaren">
            <div class="toolbar">
                <input type="text" id="searchEigenaren" placeholder="ğŸ” Zoek eigenaar...">
                <div class="view-toggle">
                    <button id="viewTableEigenaren" title="Tabel">ğŸ“‹</button>
                    <button id="viewCardsEigenaren" class="active" title="Kaarten">ğŸƒ</button>
                </div>
            </div>
            <div class="results-info"><span id="eigenarenCount"></span></div>
            <div id="eigenarenTableView" class="data-table-wrapper"
                style="max-height: 600px; overflow-y: auto; display:none;">
                <table class="data-table" id="eigenarenTable">
                    <thead>
                        <tr>
                            <th data-sort="naam">Naam</th>
                            <th data-sort="email">Email</th>
                            <th data-sort="telefoon">Telefoon</th>
                            <th data-sort="plaats">Plaats</th>
                            <th data-sort="count">Woningen</th>
                            <th data-sort="totalInhuur">Totaal Inhuur</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="eigenarenCardsView" class="cards-grid"></div>
        </div>

        <!-- Huurders Panel -->
        <div class="panel" id="panel-huurders">
            <div class="toolbar">
                <input type="text" id="searchHuurders" placeholder="ğŸ” Zoek huurder...">
                <div class="view-toggle">
                    <button id="viewTableHuurders" title="Tabel">ğŸ“‹</button>
                    <button id="viewCardsHuurders" class="active" title="Kaarten">ğŸƒ</button>
                </div>
            </div>
            <div class="results-info"><span id="huurdersCount"></span></div>
            <div id="huurdersTableView" class="data-table-wrapper"
                style="max-height: 600px; overflow-y: auto; display:none;">
                <table class="data-table" id="huurdersTable">
                    <thead>
                        <tr>
                            <th data-sort="naam">Naam</th>
                            <th data-sort="type">Type</th>
                            <th data-sort="email">Email</th>
                            <th data-sort="telefoon">Telefoon</th>
                            <th data-sort="count">Woningen</th>
                            <th data-sort="totalVerhuur">Totaal Verhuur</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="huurdersCardsView" class="cards-grid"></div>
        </div>

        <!-- Relaties Panel (unified contacts) -->
        <div class="panel" id="panel-relaties">
            <div class="toolbar">
                <input type="text" id="searchRelaties" placeholder="ğŸ” Zoek naam, email, telefoon, bedrijf...">
                <select id="filterRelatieType">
                    <option value="">Alle types</option>
                    <option value="Eigenaar">ğŸ‘¤ Eigenaren</option>
                    <option value="Huurder">ğŸ‘¥ Huurders</option>
                    <option value="Leverancier">ğŸ”§ Leveranciers</option>
                    <option value="Overig">ğŸ“‹ Overig</option>
                </select>
            </div>
            <div class="results-info"><span id="relatiesCount"></span></div>
            <div class="data-table-wrapper" style="max-height: 600px; overflow-y: auto;">
                <table class="data-table" id="relatiesTable">
                    <thead>
                        <tr>
                            <th data-sort="type" style="width:80px;">Type</th>
                            <th data-sort="naam">Naam</th>
                            <th data-sort="email">Email</th>
                            <th data-sort="telefoon">Telefoon</th>
                            <th data-sort="plaats">Plaats</th>
                            <th data-sort="info">Info</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Financieel Panel -->
        <div class="panel" id="panel-financieel">
            <div class="toolbar">
                <input type="text" id="searchFinancieel" placeholder="ğŸ” Zoek...">
                <select id="filterFinStatus">
                    <option value="">Alle status</option>
                    <option value="Beschikbaar">Beschikbaar</option>
                    <option value="Verhuurd">Verhuurd</option>
                    <option value="Leegstand">Leegstand</option>
                </select>
                <select id="sortFinancieel">
                    <option value="marge_desc">Hoogste marge</option>
                    <option value="marge_asc">Laagste marge</option>
                    <option value="inhuur_desc">Hoogste inhuur</option>
                    <option value="verhuur_desc">Hoogste verhuur</option>
                </select>
                <div class="view-toggle">
                    <button id="viewTableFinancieel" title="Tabel">ğŸ“‹</button>
                    <button id="viewCardsFinancieel" class="active" title="Kaarten">ğŸƒ</button>
                </div>
            </div>
            <div id="financieelTableView" class="data-table-wrapper"
                style="max-height: 600px; overflow-y: auto; display:none;">
                <table class="data-table" id="financieelTable">
                    <thead>
                        <tr>
                            <th data-sort="object_id">Object</th>
                            <th data-sort="adres">Adres</th>
                            <th data-sort="plaats">Plaats</th>
                            <th data-sort="inhuur_totaal_excl_btw">Inhuur</th>
                            <th data-sort="verhuur_totaal_excl_btw">Verhuur</th>
                            <th data-sort="marge_maand_excl_btw">Marge</th>
                            <th data-sort="marge_percentage">%</th>
                            <th data-sort="beschikbaarheid_status">Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="financieelCardsView" class="cards-grid"></div>
        </div>

        <!-- Sales Prep Panel -->
        <div class="panel" id="panel-salesprep">
            <div class="sales-prep">
                <div class="calc-card">
                    <h3>ğŸ  Selecteer Woning</h3>
                    <div class="search-select" id="propertySearchSelect">
                        <input type="text" id="salesPropSearch" placeholder="ğŸ” Zoek object, adres, plaats...">
                        <div class="dropdown" id="salesPropDropdown"></div>
                    </div>
                    <div id="salesPropInfo" style="margin-top:1rem;"></div>
                </div>

                <div class="calc-card">
                    <h3>ğŸ¯ Klant Budget Matcher</h3>
                    <div
                        style="display:grid; grid-template-columns: 1fr 0.6fr 0.8fr 0.8fr; gap:0.25rem 0.5rem; font-size:0.75rem; color:var(--gray);">
                        <span>ğŸ“ Postcode</span><span>Max km</span><span>Min â‚¬ PPPW</span><span>Max â‚¬ PPPW</span>
                    </div>
                    <div class="budget-inputs" style="margin-top:0.25rem;">
                        <input type="text" id="targetPostcode" placeholder="3012" style="flex:1;">
                        <input type="number" id="maxDistance" placeholder="15" value="15" style="flex:0.6;">
                        <input type="number" id="budgetMin" placeholder="175" value="175" style="flex:0.8;">
                        <input type="number" id="budgetMax" placeholder="195" value="195" style="flex:0.8;">
                    </div>
                    <div
                        style="display:grid; grid-template-columns: 0.6fr 0.8fr 1fr auto; gap:0.25rem 0.5rem; font-size:0.75rem; color:var(--gray); margin-top:0.5rem;">
                        <span>Min kamers</span><span>Vrij binnen</span><span>Stad</span><span></span>
                    </div>
                    <div class="budget-inputs" style="margin-top:0.25rem;">
                        <input type="number" id="budgetRooms" placeholder="2" style="flex:0.6;">
                        <select id="availableWithin"
                            style="flex:0.8; padding:0.4rem; border:2px solid #e0e0e0; border-radius: var(--radius);">
                            <option value="0">Nu vrij</option>
                            <option value="2">2 weken</option>
                            <option value="4" selected>4 weken</option>
                            <option value="8">8 weken</option>
                            <option value="12">12 weken</option>
                        </select>
                        <select id="budgetCity"
                            style="flex:1; padding:0.4rem; border:2px solid #e0e0e0; border-radius: var(--radius);">
                            <option value="">Alle steden</option>
                        </select>
                        <button class="btn" onclick="runBudgetMatcher()" style="flex:0 0 auto;">ğŸ”</button>
                    </div>
                    <div id="matcherStatus" style="color: var(--gray); font-size: 0.8rem; margin-top: 0.5rem;"></div>
                    <div id="matcherResults" class="matcher-results" style="max-height:200px;">
                        <p style="color: var(--gray); text-align: center; font-size:0.8rem;">Vul criteria in en klik ğŸ”
                        </p>
                        </p>
                    </div>
                </div>

                <div class="calc-card">
                    <h3>ğŸ’° Prijs Calculator</h3>
                    <div class="calc-row">
                        <span class="label">Inhuur (kostprijs)</span>
                        <span class="value" id="calcInhuur">â‚¬ 0</span>
                    </div>
                    <div class="calc-row">
                        <span class="label">Target marge %</span>
                        <input type="number" class="calc-input" id="calcMargeTarget" value="15" min="0" max="100">
                    </div>
                    <div class="calc-row">
                        <span class="label">Min. verhuurprijs (kaal)</span>
                        <span class="value positive" id="calcMinVerhuur">â‚¬ 0</span>
                    </div>
                    <div class="margin-bar">
                        <div class="fill" id="marginFill" style="width: 0%"></div>
                    </div>

                    <h3 style="margin-top:1.5rem">ğŸ“¦ Maandelijkse Services (PPPW)</h3>
                    <p style="font-size:0.75rem; color:var(--gray); margin-bottom:0.5rem;">Per persoon per week Ã—
                        capaciteit Ã— 4.33 weken</p>
                    <div class="toggle-row" id="serviceToggles">
                        <button class="toggle-btn" data-service="gwe" data-type="fixed">ğŸ’¡ GWE</button>
                        <button class="toggle-btn" data-service="meubilering" data-pppw="15" data-type="pppw">ğŸ›‹ï¸
                            Meubilering â‚¬15</button>
                        <button class="toggle-btn" data-service="stoffering" data-pppw="10" data-type="pppw">ğŸª‘
                            Stoffering â‚¬10</button>
                        <button class="toggle-btn" data-service="internet" data-pppw="5" data-type="pppw">ğŸ“¶ Internet
                            â‚¬5</button>
                        <button class="toggle-btn" data-service="bedlinnen" data-pppw="3" data-type="pppw">ğŸ›ï¸ Bedlinnen
                            â‚¬3</button>
                        <button class="toggle-btn" data-service="tuinonderhoud" data-pppw="2.5" data-type="pppw">ğŸŒ¿ Tuin
                            â‚¬2.50</button>
                        <button class="toggle-btn" data-service="afvalverwerking" data-pppw="2" data-type="pppw">ğŸ—‘ï¸
                            Afval â‚¬2</button>
                    </div>

                    <div id="servicesBreakdown"
                        style="margin-top:0.75rem; padding:0.75rem; background:#f8f9fa; border-radius:var(--radius); font-size:0.85rem;">
                        <div id="servicesDetails"></div>
                    </div>

                    <h3 style="margin-top:1.5rem">ğŸ§¹ Eenmalige Kosten (bij start contract)</h3>
                    <div class="toggle-row" id="onetimeToggles">
                        <button class="toggle-btn" data-service="schoonmaak" data-onetime="250">Schoonmaak â‚¬250</button>
                        <button class="toggle-btn" data-service="schoonmaak_int" data-onetime="375">Schoonmaak Intensief
                            â‚¬375</button>
                    </div>
                    <div class="calc-row" style="margin-top:0.5rem;">
                        <span class="label" style="color:var(--gray);">Eenmalige kosten</span>
                        <span class="value" id="calcOnetime" style="color:var(--gray);">â‚¬ 0</span>
                    </div>

                    <div style="margin-top:1.5rem; padding-top:1rem; border-top: 2px solid var(--primary-light);">
                        <div class="calc-row">
                            <span class="label"><strong>Totaal verhuur/maand</strong></span>
                            <span class="value positive" id="calcTotalAdvice" style="font-size:1.25rem">â‚¬ 0</span>
                        </div>
                        <div class="calc-row" style="margin-top:0.5rem;">
                            <span class="label">PPPW (met services)</span>
                            <span class="value positive" id="calcPppwWithServices">â‚¬ 0</span>
                        </div>
                        <div class="calc-row">
                            <span class="label">PPPW (kale huur)</span>
                            <span class="value" id="calcPppwBase">â‚¬ 0</span>
                        </div>
                    </div>
                </div>

                <div class="calc-card">
                    <h3>ğŸ“Š Scenario Vergelijking</h3>

                    <!-- Cleaner comparison table -->
                    <table style="width:100%; border-collapse:collapse; font-size:0.95rem; margin-bottom:1rem;">
                        <thead>
                            <tr style="border-bottom:2px solid var(--primary-light);">
                                <th style="text-align:left; padding:0.5rem 0; color:var(--gray);"></th>
                                <th style="text-align:right; padding:0.5rem; color:var(--gray); font-weight:600;">Huidig
                                </th>
                                <th style="text-align:right; padding:0.5rem; color:var(--primary); font-weight:600;">
                                    Nieuw</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding:0.6rem 0; color:var(--gray);">Verhuur</td>
                                <td style="text-align:right; padding:0.6rem; font-weight:600;" id="calcHuidigeVerhuur">â‚¬
                                    0</td>
                                <td style="text-align:right; padding:0.6rem;"><input type="number" class="calc-input"
                                        id="calcNieuweVerhuur" value="0" step="50"
                                        style="width:100%; text-align:right; font-size:1rem;"></td>
                            </tr>
                            <tr style="background:#f8f9fa;">
                                <td style="padding:0.6rem 0; color:var(--gray);">âˆ’ Inhuur</td>
                                <td style="text-align:right; padding:0.6rem; color:var(--gray);" id="calcInhuurRef">â‚¬ 0
                                </td>
                                <td style="text-align:right; padding:0.6rem; color:var(--gray);" id="calcInhuurRef2">â‚¬ 0
                                </td>
                            </tr>
                            <tr style="font-weight:600;">
                                <td style="padding:0.6rem 0; color:var(--gray);">= Marge</td>
                                <td style="text-align:right; padding:0.6rem;" id="calcHuidigeMarge">â‚¬ 0</td>
                                <td style="text-align:right; padding:0.6rem;" id="calcNieuweMarge">â‚¬ 0</td>
                            </tr>
                            <tr style="background:#f8f9fa;">
                                <td style="padding:0.6rem 0; color:var(--gray);">Marge %</td>
                                <td style="text-align:right; padding:0.6rem;" id="calcHuidigeMargePct">0%</td>
                                <td style="text-align:right; padding:0.6rem;" id="calcNieuweMargePct">0%</td>
                            </tr>
                            <tr>
                                <td style="padding:0.6rem 0; color:var(--gray);">PPPW</td>
                                <td style="text-align:right; padding:0.6rem;" id="calcHuidigePppw">â‚¬0</td>
                                <td style="text-align:right; padding:0.6rem;" id="calcNieuwePppw">â‚¬0</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Result section -->
                    <div
                        style="background:linear-gradient(135deg, #e8f5e9, #c8e6c9); padding:1rem; border-radius:var(--radius); margin-bottom:1rem;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                            <span style="color:var(--gray);">Verschil/maand</span>
                            <span style="font-size:1.2rem; font-weight:600;" id="calcVerschil">â‚¬ 0</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="color:var(--gray); font-weight:600;">Verschil/jaar</span>
                            <span style="font-size:1.5rem; font-weight:700;" id="calcVerschilJaar">â‚¬ 0</span>
                        </div>
                    </div>

                    <!-- Contact info -->
                    <div id="quickInfo"
                        style="font-size:0.9rem; padding:0.75rem; background:#f8f9fa; border-radius:var(--radius);">
                        <p style="color: var(--gray); margin:0;">Selecteer een woning om contact info te zien.</p>
                    </div>
                </div>

                <div class="calc-card"
                    style="grid-column: span 2; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h3 style="color: white;">ğŸ“‹ Contract Output</h3>
                    <p style="opacity: 0.9; font-size: 0.85rem; margin-bottom: 1rem;">
                        Wanneer je tevreden bent met de berekening, genereer contract-klare data.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="font-size:0.8rem; opacity:0.8;">Startdatum contract</label>
                            <input type="date" id="contractStartDate" class="calc-input"
                                style="width:100%; background:rgba(255,255,255,0.9); color:#333;">
                        </div>
                        <div>
                            <label style="font-size:0.8rem; opacity:0.8;">Looptijd (maanden)</label>
                            <input type="number" id="contractDuration" class="calc-input" value="12" min="1"
                                style="width:100%; background:rgba(255,255,255,0.9); color:#333;">
                        </div>
                    </div>
                    <button class="btn" onclick="generateContractOutput()"
                        style="width:100%; background:white; color:#667eea; font-weight:600; padding:0.75rem;">
                        ğŸ“„ Genereer Contract Data
                    </button>
                    <div id="contractOutput"
                        style="margin-top:1rem; display:none; background:rgba(255,255,255,0.95); color:#333; padding:1rem; border-radius:var(--radius); font-size:0.85rem;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay -->
        <div class="overlay" id="overlay"></div>

        <!-- Detail Panel -->
        <div class="detail-panel" id="detailPanel">
            <div class="detail-panel-header">
                <div style="display: flex; align-items: center;">
                    <button class="back-btn" id="panelBackBtn" onclick="goBackPanel()" style="display:none;">â†
                        Terug</button>
                    <h2 id="panelTitle">Details</h2>
                </div>
                <button class="detail-panel-close" onclick="closePanel()">&times;</button>
            </div>
            <div class="detail-panel-body" id="panelBody"></div>
        </div>

        <script>
            let allProperties = [];
            let allOwners = [];
            let allTenants = [];
            let currentSort = { column: null, asc: true };
            let dataLoadAttempts = 0;
            const maxAttempts = 10;

            document.addEventListener('DOMContentLoaded', loadDataAndInit);

            function loadDataAndInit() {
                // Show loading state
                document.getElementById('lastUpdate').textContent = 'Data laden...';

                // Check if already loaded (script tag fallback)
                if (typeof SALES_DATA !== 'undefined') {
                    init();
                    return;
                }

                // Try dynamic loading
                loadDataScript();
            }

            function loadDataScript() {
                dataLoadAttempts++;

                const script = document.createElement('script');
                script.src = 'data.js?t=' + Date.now(); // Cache bust
                script.onload = function () {
                    // Small delay to ensure SALES_DATA is parsed
                    setTimeout(function () {
                        if (typeof SALES_DATA !== 'undefined') {
                            init();
                        } else if (dataLoadAttempts < maxAttempts) {
                            document.getElementById('lastUpdate').textContent =
                                'Data laden... poging ' + dataLoadAttempts + '/' + maxAttempts;
                            setTimeout(loadDataScript, 1000);
                        } else {
                            showDataError();
                        }
                    }, 200);
                };
                script.onerror = function () {
                    if (dataLoadAttempts < maxAttempts) {
                        document.getElementById('lastUpdate').textContent =
                            'Data laden... poging ' + dataLoadAttempts + '/' + maxAttempts;
                        setTimeout(loadDataScript, 1500);
                    } else {
                        showDataError();
                    }
                };
                document.head.appendChild(script);
            }

            function showDataError() {
                document.getElementById('lastUpdate').innerHTML =
                    '<span style="color:#dc3545">âš ï¸ data.js niet geladen</span>';
                document.querySelector('.container').innerHTML = `
                    <div style="background:white;padding:2rem;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);max-width:600px;margin:2rem auto;">
                        <h2 style="color:#dc3545;margin-bottom:1rem;">âš ï¸ Data kon niet worden geladen</h2>
                        <p style="margin-bottom:1rem;">Het bestand <strong>data.js</strong> is niet beschikbaar. Dit kan komen door:</p>
                        <ul style="margin-bottom:1rem;padding-left:1.5rem;">
                            <li>OneDrive synchronisatie nog bezig - wacht even en herlaad de pagina</li>
                            <li>Bestand nog niet gedownload - klik rechts op data.js â†’ "Altijd bewaren op dit apparaat"</li>
                            <li>Browser blokkade - probeer Edge in plaats van Chrome</li>
                        </ul>
                        <button onclick="location.reload()" style="background:#2ba306;color:white;border:none;padding:0.75rem 1.5rem;border-radius:8px;cursor:pointer;font-size:1rem;">
                            ğŸ”„ Pagina herladen
                        </button>
                    </div>
                `;
            }

            function init() {
                if (typeof SALES_DATA === 'undefined') {
                    showDataError();
                    return;
                }

                allProperties = SALES_DATA.properties;
                buildOwnersList();
                buildTenantsList();

                // Update header
                const genDate = new Date(SALES_DATA.generated);
                document.getElementById('lastUpdate').textContent =
                    `Data: ${genDate.toLocaleDateString('nl-NL')} ${genDate.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' })}`;

                // Update KPIs
                document.getElementById('kpiTotal').textContent = SALES_DATA.stats.total;
                document.getElementById('kpiAvailable').textContent = SALES_DATA.stats.available;
                document.getElementById('kpiRented').textContent = SALES_DATA.stats.rented;
                document.getElementById('kpiLeegstand').textContent = SALES_DATA.stats.leegstand || 0;
                document.getElementById('kpiMarge').textContent = formatMoney(SALES_DATA.stats.total_marge_maand);
                document.getElementById('kpiMargeJaar').textContent = formatMoney(SALES_DATA.stats.total_marge_jaar);

                // Populate city filter
                const cities = [...new Set(allProperties.map(p => p.plaats).filter(Boolean))].sort();
                const citySelect = document.getElementById('filterStad');
                cities.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c; opt.textContent = c;
                    citySelect.appendChild(opt);
                });

                // Initial renders
                renderWoningen();
                renderBinnenkort();
                renderEigenaren();
                renderHuurders();
                renderRelaties();
                renderFinancieel();

                // Setup tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function () {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                        this.classList.add('active');
                        document.getElementById('panel-' + this.dataset.tab).classList.add('active');
                    });
                });

                // Filters
                document.getElementById('searchWoningen').addEventListener('input', renderWoningen);
                document.getElementById('filterStatus').addEventListener('change', renderWoningen);
                document.getElementById('filterStad').addEventListener('change', renderWoningen);
                document.getElementById('searchBinnenkort').addEventListener('input', renderBinnenkort);
                document.getElementById('filterBinnenkortDays').addEventListener('change', renderBinnenkort);
                document.getElementById('searchEigenaren').addEventListener('input', renderEigenaren);
                document.getElementById('searchHuurders').addEventListener('input', renderHuurders);
                document.getElementById('searchRelaties').addEventListener('input', renderRelaties);
                document.getElementById('filterRelatieType').addEventListener('change', renderRelaties);
                document.getElementById('searchFinancieel').addEventListener('input', renderFinancieel);
                document.getElementById('filterFinStatus').addEventListener('change', renderFinancieel);
                document.getElementById('sortFinancieel').addEventListener('change', renderFinancieel);

                // View toggle for Woningen
                document.getElementById('viewTableWoningen').addEventListener('click', () => {
                    document.getElementById('viewTableWoningen').classList.add('active');
                    document.getElementById('viewCardsWoningen').classList.remove('active');
                    document.getElementById('woningenTableView').style.display = 'block';
                    document.getElementById('woningenCardsView').style.display = 'none';
                });
                document.getElementById('viewCardsWoningen').addEventListener('click', () => {
                    document.getElementById('viewCardsWoningen').classList.add('active');
                    document.getElementById('viewTableWoningen').classList.remove('active');
                    document.getElementById('woningenCardsView').style.display = 'grid';
                    document.getElementById('woningenTableView').style.display = 'none';
                });

                // View toggle for Binnenkort
                document.getElementById('viewTableBinnenkort').addEventListener('click', () => {
                    document.getElementById('viewTableBinnenkort').classList.add('active');
                    document.getElementById('viewCardsBinnenkort').classList.remove('active');
                    document.getElementById('binnenkortTableView').style.display = 'block';
                    document.getElementById('binnenkortCardsView').style.display = 'none';
                });
                document.getElementById('viewCardsBinnenkort').addEventListener('click', () => {
                    document.getElementById('viewCardsBinnenkort').classList.add('active');
                    document.getElementById('viewTableBinnenkort').classList.remove('active');
                    document.getElementById('binnenkortCardsView').style.display = 'grid';
                    document.getElementById('binnenkortTableView').style.display = 'none';
                });

                // View toggle for Eigenaren
                document.getElementById('viewTableEigenaren').addEventListener('click', () => {
                    document.getElementById('viewTableEigenaren').classList.add('active');
                    document.getElementById('viewCardsEigenaren').classList.remove('active');
                    document.getElementById('eigenarenTableView').style.display = 'block';
                    document.getElementById('eigenarenCardsView').style.display = 'none';
                });
                document.getElementById('viewCardsEigenaren').addEventListener('click', () => {
                    document.getElementById('viewCardsEigenaren').classList.add('active');
                    document.getElementById('viewTableEigenaren').classList.remove('active');
                    document.getElementById('eigenarenCardsView').style.display = 'grid';
                    document.getElementById('eigenarenTableView').style.display = 'none';
                });

                // View toggle for Huurders
                document.getElementById('viewTableHuurders').addEventListener('click', () => {
                    document.getElementById('viewTableHuurders').classList.add('active');
                    document.getElementById('viewCardsHuurders').classList.remove('active');
                    document.getElementById('huurdersTableView').style.display = 'block';
                    document.getElementById('huurdersCardsView').style.display = 'none';
                });
                document.getElementById('viewCardsHuurders').addEventListener('click', () => {
                    document.getElementById('viewCardsHuurders').classList.add('active');
                    document.getElementById('viewTableHuurders').classList.remove('active');
                    document.getElementById('huurdersCardsView').style.display = 'grid';
                    document.getElementById('huurdersTableView').style.display = 'none';
                });

                // View toggle for Financieel
                document.getElementById('viewTableFinancieel').addEventListener('click', () => {
                    document.getElementById('viewTableFinancieel').classList.add('active');
                    document.getElementById('viewCardsFinancieel').classList.remove('active');
                    document.getElementById('financieelTableView').style.display = 'block';
                    document.getElementById('financieelCardsView').style.display = 'none';
                });
                document.getElementById('viewCardsFinancieel').addEventListener('click', () => {
                    document.getElementById('viewCardsFinancieel').classList.add('active');
                    document.getElementById('viewTableFinancieel').classList.remove('active');
                    document.getElementById('financieelCardsView').style.display = 'grid';
                    document.getElementById('financieelTableView').style.display = 'none';
                });

                // Overlay close
                document.getElementById('overlay').addEventListener('click', closePanel);
                document.addEventListener('keydown', e => { if (e.key === 'Escape') closePanel(); });
            }

            function formatMoney(amount) {
                if (amount == null || isNaN(amount)) return '-';
                return 'â‚¬ ' + Math.round(amount).toLocaleString('nl-NL');
            }

            function escapeHtml(str) {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function buildOwnersList() {
                const map = {};
                allProperties.forEach(p => {
                    if (!p.eigenaar_naam) return;
                    if (!map[p.eigenaar_naam]) {
                        map[p.eigenaar_naam] = {
                            naam: p.eigenaar_naam,
                            email: p.eigenaar_email,
                            telefoon: p.eigenaar_telefoon,
                            adres: p.eigenaar_adres,
                            postcode: p.eigenaar_postcode,
                            plaats: p.eigenaar_plaats,
                            iban: p.eigenaar_iban,
                            properties: [],
                            totalInhuur: 0
                        };
                    }
                    map[p.eigenaar_naam].properties.push(p);
                    map[p.eigenaar_naam].totalInhuur += (p.inhuur_totaal_excl_btw || 0);
                });
                allOwners = Object.values(map).sort((a, b) => b.properties.length - a.properties.length);
            }

            function buildTenantsList() {
                const map = {};
                allProperties.forEach(p => {
                    if (!p.huurder_naam) return;
                    if (!map[p.huurder_naam]) {
                        map[p.huurder_naam] = {
                            naam: p.huurder_naam,
                            type: p.huurder_type,
                            email: p.huurder_email,
                            telefoon: p.huurder_telefoon,
                            adres: p.huurder_adres,
                            plaats: p.huurder_plaats,
                            properties: [],
                            totalVerhuur: 0
                        };
                    }
                    map[p.huurder_naam].properties.push(p);
                    map[p.huurder_naam].totalVerhuur += (p.verhuur_totaal_excl_btw || 0);
                });
                allTenants = Object.values(map).sort((a, b) => b.properties.length - a.properties.length);
            }

            function getStatusBadge(status) {
                const cls = status === 'Beschikbaar' ? 'available' :
                    status === 'Leegstand' ? 'leegstand' : 'rented';
                return `<span class="status-badge ${cls}">${status || '-'}</span>`;
            }

            function getMoneyClass(val) {
                if (val == null) return 'money';
                return val >= 0 ? 'money positive' : 'money negative';
            }

            // ========== WONINGEN ==========
            let currentViewWoningen = 'table';

            function renderWoningen() {
                const search = document.getElementById('searchWoningen').value.toLowerCase();
                const statusFilter = document.getElementById('filterStatus').value;
                const stadFilter = document.getElementById('filterStad').value;

                let filtered = allProperties.filter(p => {
                    const matchSearch = !search ||
                        (p.adres || '').toLowerCase().includes(search) ||
                        (p.plaats || '').toLowerCase().includes(search) ||
                        (p.eigenaar_naam || '').toLowerCase().includes(search) ||
                        (p.huurder_naam || '').toLowerCase().includes(search) ||
                        (p.object_id || '').toLowerCase().includes(search);
                    const matchStatus = !statusFilter || (p.beschikbaarheid_status || '').includes(statusFilter);
                    const matchStad = !stadFilter || p.plaats === stadFilter;
                    return matchSearch && matchStatus && matchStad;
                });

                document.getElementById('resultsCount').textContent = `${filtered.length} woningen`;

                // Table view
                const tbody = document.querySelector('#woningenTable tbody');
                tbody.innerHTML = filtered.map(p => `
                <tr onclick="showPropertyDetail('${p.object_id}')">
                    <td>${p.object_id}</td>
                    <td>${p.adres || '-'}</td>
                    <td>${p.plaats || '-'}</td>
                    <td>${p.eigenaar_naam || '-'}</td>
                    <td>${p.huurder_naam || '-'}</td>
                    <td class="${getMoneyClass(p.marge_maand_excl_btw)}">${formatMoney(p.marge_maand_excl_btw)}</td>
                    <td>${getStatusBadge(p.beschikbaarheid_status)}</td>
                </tr>
            `).join('');

                // Card view
                const cardsContainer = document.getElementById('woningenCardsView');
                cardsContainer.innerHTML = filtered.map(p => {
                    const statusClass = (p.beschikbaarheid_status || '').toLowerCase().includes('beschikbaar') ? 'status-beschikbaar' :
                        (p.beschikbaarheid_status || '').toLowerCase().includes('verhuurd') ? 'status-verhuurd' : 'status-leegstand';
                    const margePct = p.verhuur_totaal_excl_btw ? Math.round((p.marge_maand_excl_btw / p.verhuur_totaal_excl_btw) * 100) : 0;
                    const margeColor = margePct >= 15 ? '#28a745' : margePct >= 10 ? '#ffc107' : '#dc3545';
                    return `
                    <div class="property-card ${statusClass}" onclick="showPropertyDetail('${p.object_id}')">
                        <div class="card-header">
                            <div>
                                <div class="card-title">${p.object_id} - ${escapeHtml(p.adres || '-')}</div>
                                <div class="card-subtitle">${escapeHtml(p.plaats || '-')}</div>
                            </div>
                            ${getStatusBadge(p.beschikbaarheid_status)}
                        </div>
                        <div class="card-body">
                            <div class="card-item">
                                <span class="card-label">Eigenaar</span>
                                <span class="card-value">${escapeHtml(p.eigenaar_naam || '-')}</span>
                            </div>
                            <div class="card-item">
                                <span class="card-label">Huurder</span>
                                <span class="card-value">${escapeHtml(p.huurder_naam || 'Leeg')}</span>
                            </div>
                            <div class="card-item">
                                <span class="card-label">Marge/maand</span>
                                <span class="card-value money">${formatMoney(p.marge_maand_excl_btw)}</span>
                            </div>
                            <div class="card-item">
                                <span class="card-label">Marge %</span>
                                <span class="card-value">${margePct}%</span>
                            </div>
                        </div>
                        <div class="marge-bar"><div class="fill" style="width:${Math.min(margePct * 3, 100)}%; background:${margeColor};"></div></div>
                    </div>
                `}).join('');
            }

            // ========== BINNENKORT BESCHIKBAAR ==========
            function renderBinnenkort() {
                const maxDays = parseInt(document.getElementById('filterBinnenkortDays').value) || 90;
                const search = document.getElementById('searchBinnenkort').value.toLowerCase();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Filter properties with verhuur_eind in the future and within maxDays
                let filtered = allProperties.filter(p => {
                    if (!p.verhuur_eind) return false;
                    const endDate = new Date(p.verhuur_eind);
                    if (isNaN(endDate.getTime())) return false;
                    const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil < 0 || daysUntil > maxDays) return false;

                    const matchSearch = !search ||
                        (p.adres || '').toLowerCase().includes(search) ||
                        (p.plaats || '').toLowerCase().includes(search) ||
                        (p.huurder_naam || '').toLowerCase().includes(search) ||
                        (p.object_id || '').toLowerCase().includes(search);
                    return matchSearch;
                });

                // Sort by days until expiry (most urgent first)
                filtered.sort((a, b) => {
                    const daysA = Math.ceil((new Date(a.verhuur_eind) - today) / (1000 * 60 * 60 * 24));
                    const daysB = Math.ceil((new Date(b.verhuur_eind) - today) / (1000 * 60 * 60 * 24));
                    return daysA - daysB;
                });

                document.getElementById('binnenkortCount').textContent = `${filtered.length} woningen binnenkort beschikbaar`;

                // Table view
                const tbody = document.querySelector('#binnenkortTable tbody');
                tbody.innerHTML = filtered.map(p => {
                    const endDate = new Date(p.verhuur_eind);
                    const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                    let daysBadgeClass = daysUntil <= 14 ? 'badge-danger' : daysUntil <= 30 ? 'badge-warning' : 'badge-info';
                    const formattedDate = endDate.toLocaleDateString('nl-NL', { day: '2-digit', month: 'short', year: 'numeric' });
                    return `
                    <tr onclick="showPropertyDetail('${p.object_id}')" style="cursor:pointer;">
                        <td>${p.object_id}</td>
                        <td>${p.adres || '-'}</td>
                        <td>${p.plaats || '-'}</td>
                        <td>${p.huurder_naam || '-'}</td>
                        <td>${formattedDate}</td>
                        <td><span class="status-badge ${daysBadgeClass}">${daysUntil}d</span></td>
                        <td class="${getMoneyClass(p.marge_maand_excl_btw)}">${formatMoney(p.marge_maand_excl_btw)}</td>
                        <td>${getStatusBadge(p.beschikbaarheid_status)}</td>
                    </tr>
                `;
                }).join('');

                // Card view
                const cardsContainer = document.getElementById('binnenkortCardsView');
                cardsContainer.innerHTML = filtered.map(p => {
                    const endDate = new Date(p.verhuur_eind);
                    const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                    const urgencyClass = daysUntil <= 14 ? 'urgent' : daysUntil <= 30 ? 'soon' : 'later';
                    const formattedDate = endDate.toLocaleDateString('nl-NL', { day: '2-digit', month: 'short' });
                    return `
                    <div class="property-card" onclick="showPropertyDetail('${p.object_id}')">
                        <div class="card-header">
                            <div>
                                <div class="card-title">${escapeHtml(p.adres || '-')}</div>
                                <div class="card-subtitle">${escapeHtml(p.plaats || '-')}</div>
                            </div>
                            <div class="countdown-badge ${urgencyClass}">${daysUntil}d</div>
                        </div>
                        <div class="card-body">
                            <div class="card-item">
                                <span class="card-label">Einddatum</span>
                                <span class="card-value">${formattedDate}</span>
                            </div>
                            <div class="card-item">
                                <span class="card-label">Huurder</span>
                                <span class="card-value">${escapeHtml(p.huurder_naam || '-')}</span>
                            </div>
                            <div class="card-item">
                                <span class="card-label">Marge</span>
                                <span class="card-value money">${formatMoney(p.marge_maand_excl_btw)}</span>
                            </div>
                            <div class="card-item">
                                <span class="card-label">Object</span>
                                <span class="card-value">${p.object_id}</span>
                            </div>
                        </div>
                    </div>
                `}).join('');
            }

            // ========== EIGENAREN ==========
            function renderEigenaren() {
                const search = document.getElementById('searchEigenaren').value.toLowerCase();
                let filtered = allOwners.filter(o => !search || o.naam.toLowerCase().includes(search));

                document.getElementById('eigenarenCount').textContent = `${filtered.length} eigenaren`;

                // Table view
                const tbody = document.querySelector('#eigenarenTable tbody');
                tbody.innerHTML = filtered.map((o, idx) => `
                <tr data-owner-idx="${idx}" style="cursor:pointer">
                    <td><strong>${escapeHtml(o.naam)}</strong></td>
                    <td>${escapeHtml(o.email || '-')}</td>
                    <td>${escapeHtml(o.telefoon || '-')}</td>
                    <td>${escapeHtml(o.plaats || '-')}</td>
                    <td>${o.properties.length}</td>
                    <td class="money">${formatMoney(o.totalInhuur)}/m</td>
                </tr>
            `).join('');

                // Add click handlers for table
                tbody.querySelectorAll('tr[data-owner-idx]').forEach(tr => {
                    tr.addEventListener('click', () => {
                        const idx = parseInt(tr.dataset.ownerIdx);
                        showOwnerDetail(filtered[idx].naam);
                    });
                });

                // Card view
                const cardsContainer = document.getElementById('eigenarenCardsView');
                cardsContainer.innerHTML = filtered.map(o => `
                    <div class="contact-card" onclick="showOwnerDetail('${escapeHtml(o.naam)}')">
                        <div class="card-name">ğŸ‘¤ ${escapeHtml(o.naam)}</div>
                        <div class="card-stats">${o.properties.length} woningen â€¢ ${formatMoney(o.totalInhuur)}/m</div>
                        <div style="font-size:0.85rem; color:var(--gray);">${escapeHtml(o.plaats || '')}</div>
                        <div class="card-contact">
                            ${o.email ? `<a href="mailto:${o.email}" onclick="event.stopPropagation()">ğŸ“§ Email</a>` : ''}
                            ${o.telefoon ? `<a href="tel:${o.telefoon}" onclick="event.stopPropagation()">ğŸ“ ${escapeHtml(o.telefoon)}</a>` : ''}
                        </div>
                    </div>
                `).join('');
            }

            function showOwnerDetail(naam) {
                const owner = allOwners.find(o => o.naam === naam);
                if (!owner) return;

                document.getElementById('panelTitle').textContent = `ğŸ‘¤ ${owner.naam}`;

                const propsHtml = owner.properties.map(p => `
                <div class="property-mini" onclick="showPropertyDetail('${p.object_id}')">
                    <div class="addr">${p.object_id} - ${p.adres}</div>
                    <div class="meta">
                        ${p.plaats || ''} | 
                        Inhuur: ${formatMoney(p.inhuur_totaal_excl_btw)} | 
                        Huurder: ${p.huurder_naam || 'Leeg'} |
                        GWE: ${formatMoney(p.inhuur_voorschot_gwe || p.voorschot_gwe_standaard)}
                    </div>
                </div>
            `).join('');

                document.getElementById('panelBody').innerHTML = `
                <div class="detail-section">
                    <h3>Contact</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="label">Email:</span><span class="value">${owner.email ? `<a href="mailto:${owner.email}">${owner.email}</a>` : '-'}</span></div>
                        <div class="detail-item"><span class="label">Telefoon:</span><span class="value">${owner.telefoon ? `<a href="tel:${owner.telefoon}">${owner.telefoon}</a>` : '-'}</span></div>
                        <div class="detail-item"><span class="label">Adres:</span><span class="value">${owner.adres || '-'}</span></div>
                        <div class="detail-item"><span class="label">Postcode:</span><span class="value">${owner.postcode || '-'}</span></div>
                        <div class="detail-item"><span class="label">Plaats:</span><span class="value">${owner.plaats || '-'}</span></div>
                        <div class="detail-item"><span class="label">IBAN:</span><span class="value">${owner.iban || '-'}</span></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Samenvatting</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="label">Woningen:</span><span class="value">${owner.properties.length}</span></div>
                        <div class="detail-item"><span class="label">Tot. Inhuur:</span><span class="value money">${formatMoney(owner.totalInhuur)}/maand</span></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Woningen (${owner.properties.length})</h3>
                    <div class="property-list">${propsHtml}</div>
                </div>
                <button class="btn" style="margin-top:1rem" onclick="window.print()">ğŸ–¨ï¸ Print</button>
            `;

                openPanel('owner', naam);
            }

            // ========== HUURDERS ==========
            function renderHuurders() {
                const search = document.getElementById('searchHuurders').value.toLowerCase();
                let filtered = allTenants.filter(t => !search || t.naam.toLowerCase().includes(search));

                document.getElementById('huurdersCount').textContent = `${filtered.length} huurders`;

                // Table view
                const tbody = document.querySelector('#huurdersTable tbody');
                tbody.innerHTML = filtered.map((t, idx) => `
                <tr data-tenant-idx="${idx}" style="cursor:pointer">
                    <td><strong>${escapeHtml(t.naam)}</strong></td>
                    <td>${escapeHtml(t.type || '-')}</td>
                    <td>${escapeHtml(t.email || '-')}</td>
                    <td>${escapeHtml(t.telefoon || '-')}</td>
                    <td>${t.properties.length}</td>
                    <td class="money">${formatMoney(t.totalVerhuur)}/m</td>
                </tr>
            `).join('');

                // Add click handlers for table
                tbody.querySelectorAll('tr[data-tenant-idx]').forEach(tr => {
                    tr.addEventListener('click', () => {
                        const idx = parseInt(tr.dataset.tenantIdx);
                        showTenantDetail(filtered[idx].naam);
                    });
                });

                // Card view
                const cardsContainer = document.getElementById('huurdersCardsView');
                cardsContainer.innerHTML = filtered.map(t => `
                    <div class="contact-card" onclick="showTenantDetail('${escapeHtml(t.naam)}')">
                        <div class="card-name">ğŸ‘¥ ${escapeHtml(t.naam)}</div>
                        <div class="card-stats">${escapeHtml(t.type || 'Particulier')} â€¢ ${t.properties.length} woningen â€¢ ${formatMoney(t.totalVerhuur)}/m</div>
                        <div class="card-contact">
                            ${t.email ? `<a href="mailto:${t.email}" onclick="event.stopPropagation()">ğŸ“§ Email</a>` : ''}
                            ${t.telefoon ? `<a href="tel:${t.telefoon}" onclick="event.stopPropagation()">ğŸ“ ${escapeHtml(t.telefoon)}</a>` : ''}
                        </div>
                    </div>
                `).join('');
            }

            function showTenantDetail(naam) {
                const tenant = allTenants.find(t => t.naam === naam);
                if (!tenant) return;

                document.getElementById('panelTitle').textContent = `ğŸ‘¥ ${tenant.naam}`;

                const propsHtml = tenant.properties.map(p => `
                <div class="property-mini" onclick="showPropertyDetail('${p.object_id}')">
                    <div class="addr">${p.object_id} - ${p.adres}</div>
                    <div class="meta">
                        ${p.plaats || ''} | 
                        Verhuur: ${formatMoney(p.verhuur_totaal_excl_btw)} | 
                        Eigenaar: ${p.eigenaar_naam || '-'} |
                        GWE: ${formatMoney(p.verhuur_voorschot_gwe)}
                    </div>
                </div>
            `).join('');

                document.getElementById('panelBody').innerHTML = `
                <div class="detail-section">
                    <h3>Contact</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="label">Type:</span><span class="value">${tenant.type || '-'}</span></div>
                        <div class="detail-item"><span class="label">Email:</span><span class="value">${tenant.email ? `<a href="mailto:${tenant.email}">${tenant.email}</a>` : '-'}</span></div>
                        <div class="detail-item"><span class="label">Telefoon:</span><span class="value">${tenant.telefoon ? `<a href="tel:${tenant.telefoon}">${tenant.telefoon}</a>` : '-'}</span></div>
                        <div class="detail-item"><span class="label">Adres:</span><span class="value">${tenant.adres || '-'}</span></div>
                        <div class="detail-item"><span class="label">Plaats:</span><span class="value">${tenant.plaats || '-'}</span></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Samenvatting</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="label">Woningen:</span><span class="value">${tenant.properties.length}</span></div>
                        <div class="detail-item"><span class="label">Tot. Verhuur:</span><span class="value money">${formatMoney(tenant.totalVerhuur)}/maand</span></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Gehuurde Woningen (${tenant.properties.length})</h3>
                    <div class="property-list">${propsHtml}</div>
                </div>
                <button class="btn" style="margin-top:1rem" onclick="window.print()">ğŸ–¨ï¸ Print</button>
            `;

                openPanel('tenant', naam);
            }

            // ========== RELATIES (unified search) ==========
            function renderRelaties() {
                const search = document.getElementById('searchRelaties').value.toLowerCase();
                const typeFilter = document.getElementById('filterRelatieType').value;

                // Combine owners and tenants into relaties list
                let relaties = [];

                // Add owners as relaties
                allOwners.forEach(o => {
                    relaties.push({
                        type: 'Eigenaar',
                        typeIcon: 'ğŸ‘¤',
                        naam: o.naam,
                        email: o.email || '',
                        telefoon: o.telefoon || '',
                        plaats: o.plaats || '',
                        info: `${o.properties.length} woningen | ${formatMoney(o.totalInhuur)}/m`
                    });
                });

                // Add tenants as relaties
                allTenants.forEach(t => {
                    relaties.push({
                        type: 'Huurder',
                        typeIcon: 'ğŸ‘¥',
                        naam: t.naam,
                        email: t.email || '',
                        telefoon: t.telefoon || '',
                        plaats: '',
                        info: `${t.type} | ${t.properties.length} woningen | ${formatMoney(t.totalVerhuur)}/m`
                    });
                });

                // Filter by type
                if (typeFilter) {
                    relaties = relaties.filter(r => r.type === typeFilter);
                }

                // Filter by search
                if (search) {
                    relaties = relaties.filter(r =>
                        r.naam.toLowerCase().includes(search) ||
                        r.email.toLowerCase().includes(search) ||
                        r.telefoon.toLowerCase().includes(search) ||
                        r.plaats.toLowerCase().includes(search)
                    );
                }

                document.getElementById('relatiesCount').textContent = `${relaties.length} relaties`;

                const tbody = document.querySelector('#relatiesTable tbody');
                tbody.innerHTML = relaties.map(r => `
                    <tr>
                        <td>${r.typeIcon}</td>
                        <td><strong>${escapeHtml(r.naam)}</strong></td>
                        <td>${r.email ? `<a href="mailto:${r.email}">${escapeHtml(r.email)}</a>` : '-'}</td>
                        <td>${r.telefoon ? `<a href="tel:${r.telefoon}">${escapeHtml(r.telefoon)}</a>` : '-'}</td>
                        <td>${escapeHtml(r.plaats)}</td>
                        <td style="font-size:0.85rem; color:var(--gray);">${escapeHtml(r.info)}</td>
                    </tr>
                `).join('');
            }

            // ========== FINANCIEEL ==========
            function renderFinancieel() {
                const search = document.getElementById('searchFinancieel').value.toLowerCase();
                const statusFilter = document.getElementById('filterFinStatus').value;
                const sortMode = document.getElementById('sortFinancieel').value;

                let filtered = allProperties.filter(p => {
                    const matchSearch = !search ||
                        (p.adres || '').toLowerCase().includes(search) ||
                        (p.object_id || '').toLowerCase().includes(search);
                    const matchStatus = !statusFilter || (p.beschikbaarheid_status || '').includes(statusFilter);
                    return matchSearch && matchStatus;
                });

                // Sort
                filtered.sort((a, b) => {
                    switch (sortMode) {
                        case 'marge_desc': return (b.marge_maand_excl_btw || 0) - (a.marge_maand_excl_btw || 0);
                        case 'marge_asc': return (a.marge_maand_excl_btw || 0) - (b.marge_maand_excl_btw || 0);
                        case 'inhuur_desc': return (b.inhuur_totaal_excl_btw || 0) - (a.inhuur_totaal_excl_btw || 0);
                        case 'verhuur_desc': return (b.verhuur_totaal_excl_btw || 0) - (a.verhuur_totaal_excl_btw || 0);
                        default: return 0;
                    }
                });

                // Table view
                const tbody = document.querySelector('#financieelTable tbody');
                tbody.innerHTML = filtered.map(p => `
                <tr onclick="showPropertyDetail('${p.object_id}')">
                    <td>${p.object_id}</td>
                    <td>${p.adres || '-'}</td>
                    <td>${p.plaats || '-'}</td>
                    <td class="money">${formatMoney(p.inhuur_totaal_excl_btw)}</td>
                    <td class="money">${formatMoney(p.verhuur_totaal_excl_btw)}</td>
                    <td class="${getMoneyClass(p.marge_maand_excl_btw)}">${formatMoney(p.marge_maand_excl_btw)}</td>
                    <td>${p.marge_percentage ? p.marge_percentage.toFixed(1) + '%' : '-'}</td>
                    <td>${getStatusBadge(p.beschikbaarheid_status)}</td>
                </tr>
            `).join('');

                // Card view
                const cardsContainer = document.getElementById('financieelCardsView');
                cardsContainer.innerHTML = filtered.map(p => {
                    const margePct = p.marge_percentage || 0;
                    const margeColor = margePct >= 15 ? '#28a745' : margePct >= 10 ? '#ffc107' : '#dc3545';
                    const inhuur = p.inhuur_totaal_excl_btw || 0;
                    const verhuur = p.verhuur_totaal_excl_btw || 0;
                    const maxVal = Math.max(inhuur, verhuur, 1);
                    return `
                    <div class="property-card" onclick="showPropertyDetail('${p.object_id}')">
                        <div class="card-header">
                            <div>
                                <div class="card-title">${escapeHtml(p.adres || '-')}</div>
                                <div class="card-subtitle">${p.object_id} â€¢ ${escapeHtml(p.plaats || '-')}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:1.2rem; font-weight:700; color:${margeColor};">${margePct.toFixed(1)}%</div>
                                <div style="font-size:0.8rem; color:var(--gray);">marge</div>
                            </div>
                        </div>
                        <div style="margin-top:0.75rem;">
                            <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:0.25rem;">
                                <span>Inhuur: ${formatMoney(inhuur)}</span>
                                <span>Verhuur: ${formatMoney(verhuur)}</span>
                            </div>
                            <div style="display:flex; gap:4px; height:20px;">
                                <div style="flex:${inhuur}; background:#e74c3c; border-radius:4px; display:flex; align-items:center; justify-content:center; color:white; font-size:0.7rem;">IN</div>
                                <div style="flex:${verhuur}; background:#27ae60; border-radius:4px; display:flex; align-items:center; justify-content:center; color:white; font-size:0.7rem;">OUT</div>
                            </div>
                        </div>
                        <div style="margin-top:0.5rem; font-size:0.9rem; font-weight:600; color:${margeColor};">
                            Marge: ${formatMoney(p.marge_maand_excl_btw)}/m
                        </div>
                    </div>
                `}).join('');
            }

            // ========== PROPERTY DETAIL ==========
            function showPropertyDetail(objectId) {
                const p = allProperties.find(prop => prop.object_id === objectId);
                if (!p) return;

                document.getElementById('panelTitle').textContent = `ğŸ  ${p.object_id} - ${p.adres}`;

                document.getElementById('panelBody').innerHTML = `
                <div class="detail-section">
                    <h3>Woning</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="label">Object:</span><span class="value">${p.object_id}</span></div>
                        <div class="detail-item"><span class="label">Adres:</span><span class="value">${p.adres || '-'}</span></div>
                        <div class="detail-item"><span class="label">Postcode:</span><span class="value">${p.postcode || '-'}</span></div>
                        <div class="detail-item"><span class="label">Plaats:</span><span class="value">${p.plaats || '-'}</span></div>
                        <div class="detail-item"><span class="label">Type:</span><span class="value">${p.woning_type || '-'}</span></div>
                        <div class="detail-item"><span class="label">Opp.:</span><span class="value">${p.oppervlakte_m2 ? p.oppervlakte_m2 + ' mÂ²' : '-'}</span></div>
                        <div class="detail-item"><span class="label">Slaapk.:</span><span class="value">${p.aantal_slaapkamers || '-'}</span></div>
                        <div class="detail-item"><span class="label">Capaciteit:</span><span class="value">${p.capaciteit_personen || '-'}</span></div>
                        <div class="detail-item"><span class="label">Status:</span><span class="value">${getStatusBadge(p.beschikbaarheid_status)}</span></div>
                        <div class="detail-item"><span class="label">Kluis 1:</span><span class="value">${p.kluis_code_1 || '-'}</span></div>
                        <div class="detail-item"><span class="label">Kluis 2:</span><span class="value">${p.kluis_code_2 || '-'}</span></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>ğŸ‘¤ Eigenaar</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="label">Naam:</span><span class="value">${p.eigenaar_naam || '-'}</span></div>
                        <div class="detail-item"><span class="label">Email:</span><span class="value">${p.eigenaar_email ? `<a href="mailto:${p.eigenaar_email}">${p.eigenaar_email}</a>` : '-'}</span></div>
                        <div class="detail-item"><span class="label">Telefoon:</span><span class="value">${p.eigenaar_telefoon ? `<a href="tel:${p.eigenaar_telefoon}">${p.eigenaar_telefoon}</a>` : '-'}</span></div>
                        <div class="detail-item"><span class="label">IBAN:</span><span class="value">${p.eigenaar_iban || '-'}</span></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>ğŸ‘¥ Huurder</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="label">Naam:</span><span class="value">${p.huurder_naam || '-'}</span></div>
                        <div class="detail-item"><span class="label">Type:</span><span class="value">${p.huurder_type || '-'}</span></div>
                        <div class="detail-item"><span class="label">Email:</span><span class="value">${p.huurder_email ? `<a href="mailto:${p.huurder_email}">${p.huurder_email}</a>` : '-'}</span></div>
                        <div class="detail-item"><span class="label">Telefoon:</span><span class="value">${p.huurder_telefoon ? `<a href="tel:${p.huurder_telefoon}">${p.huurder_telefoon}</a>` : '-'}</span></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>ğŸ’° Inhuur (van eigenaar)</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="label">Bedrag:</span><span class="value money">${formatMoney(p.inhuur_totaal_excl_btw)}/m</span></div>
                        <div class="detail-item"><span class="label">Borg:</span><span class="value">${formatMoney(p.inhuur_borg)}</span></div>
                        <div class="detail-item"><span class="label">GWE:</span><span class="value">${formatMoney(p.inhuur_voorschot_gwe)}</span></div>
                        <div class="detail-item"><span class="label">Start:</span><span class="value">${p.inhuur_start || '-'}</span></div>
                        <div class="detail-item"><span class="label">Eind:</span><span class="value">${p.inhuur_eind || '-'}</span></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>ğŸ’µ Verhuur (aan huurder)</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="label">Bedrag:</span><span class="value money">${formatMoney(p.verhuur_totaal_excl_btw)}/m</span></div>
                        <div class="detail-item"><span class="label">Borg:</span><span class="value">${formatMoney(p.verhuur_borg)}</span></div>
                        <div class="detail-item"><span class="label">GWE:</span><span class="value">${formatMoney(p.verhuur_voorschot_gwe)}</span></div>
                        <div class="detail-item"><span class="label">Start:</span><span class="value">${p.verhuur_start || '-'}</span></div>
                        <div class="detail-item"><span class="label">Eind:</span><span class="value">${p.verhuur_eind || '-'}</span></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>ğŸ“Š Marge</h3>
                    <div class="detail-grid">
                        <div class="detail-item"><span class="label">Maand:</span><span class="value ${getMoneyClass(p.marge_maand_excl_btw)}">${formatMoney(p.marge_maand_excl_btw)}</span></div>
                        <div class="detail-item"><span class="label">Jaar:</span><span class="value ${getMoneyClass(p.marge_jaar_excl_btw)}">${formatMoney(p.marge_jaar_excl_btw)}</span></div>
                        <div class="detail-item"><span class="label">Percentage:</span><span class="value">${p.marge_percentage ? p.marge_percentage.toFixed(1) + '%' : '-'}</span></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>ğŸ“ Documenten</h3>
                    <div class="detail-grid">
                        ${p.sharepoint_folder ? `<div class="detail-item"><span class="label">Folder:</span><span class="value"><a href="${p.sharepoint_folder}" target="_blank">ğŸ“‚ Open</a></span></div>` : ''}
                        ${p.sharepoint_inhuur ? `<div class="detail-item"><span class="label">Inhuur:</span><span class="value"><a href="${p.sharepoint_inhuur}" target="_blank">ğŸ“‚ Open</a></span></div>` : ''}
                        ${p.sharepoint_verhuur ? `<div class="detail-item"><span class="label">Verhuur:</span><span class="value"><a href="${p.sharepoint_verhuur}" target="_blank">ğŸ“‚ Open</a></span></div>` : ''}
                    </div>
                </div>

                <button class="btn" style="margin-top:1rem" onclick="window.print()">ğŸ–¨ï¸ Print</button>
            `;

                openPanel('property', objectId);
            }

            function openPanel(viewType, id) {
                // Track history for back button
                if (viewType && id) {
                    panelHistory.push({ type: viewType, id: id });
                }
                document.getElementById('detailPanel').classList.add('open');
                document.getElementById('overlay').classList.add('active');
                updateBackButton();
            }

            function closePanel() {
                document.getElementById('detailPanel').classList.remove('open');
                document.getElementById('overlay').classList.remove('active');
                panelHistory = [];
                updateBackButton();
            }

            // Panel navigation history
            let panelHistory = [];

            function updateBackButton() {
                const backBtn = document.getElementById('panelBackBtn');
                if (panelHistory.length > 1) {
                    backBtn.style.display = 'inline-block';
                } else {
                    backBtn.style.display = 'none';
                }
            }

            function goBackPanel() {
                if (panelHistory.length > 1) {
                    panelHistory.pop(); // Remove current
                    const prev = panelHistory[panelHistory.length - 1];
                    // Re-render without adding to history
                    panelHistory.pop();
                    if (prev.type === 'owner') {
                        showOwnerDetail(prev.id);
                    } else if (prev.type === 'tenant') {
                        showTenantDetail(prev.id);
                    } else if (prev.type === 'property') {
                        showPropertyDetail(prev.id);
                    }
                }
            }

            // ========== SALES PREP CALCULATOR ==========
            let salesSelectedProp = null;
            let selectedServices = [];

            function initSalesPrep() {
                // Populate cities for budget matcher
                const cities = [...new Set(allProperties.map(p => p.plaats).filter(Boolean))].sort();
                const budgetCity = document.getElementById('budgetCity');
                cities.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    budgetCity.appendChild(opt);
                });

                // Setup searchable dropdown
                const searchInput = document.getElementById('salesPropSearch');
                const dropdown = document.getElementById('salesPropDropdown');

                searchInput.addEventListener('focus', () => {
                    renderPropertyDropdown('');
                    dropdown.classList.add('open');
                });

                searchInput.addEventListener('input', (e) => {
                    renderPropertyDropdown(e.target.value);
                    dropdown.classList.add('open');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#propertySearchSelect')) {
                        dropdown.classList.remove('open');
                    }
                });

                // Margin target change
                document.getElementById('calcMargeTarget').addEventListener('input', updateSalesCalc);

                // New verhuur input
                document.getElementById('calcNieuweVerhuur').addEventListener('input', updateSalesCalc);

                // Service toggles
                document.querySelectorAll('#serviceToggles .toggle-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        this.classList.toggle('active');
                        updateSalesCalc();
                    });
                });

                // One-time cost toggles
                document.querySelectorAll('#onetimeToggles .toggle-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        this.classList.toggle('active');
                        updateSalesCalc();
                    });
                });
            }

            function renderPropertyDropdown(search) {
                const dropdown = document.getElementById('salesPropDropdown');
                const searchLower = search.toLowerCase();

                const filtered = allProperties.filter(p => {
                    if (!search) return true;
                    return (p.object_id || '').toLowerCase().includes(searchLower) ||
                        (p.adres || '').toLowerCase().includes(searchLower) ||
                        (p.plaats || '').toLowerCase().includes(searchLower) ||
                        (p.eigenaar_naam || '').toLowerCase().includes(searchLower) ||
                        (p.huurder_naam || '').toLowerCase().includes(searchLower);
                }).slice(0, 50); // Limit to 50 results

                dropdown.innerHTML = filtered.map(p => {
                    const pppw = p.verhuur_pppw ? `â‚¬${p.verhuur_pppw.toFixed(0)}` : '-';
                    const isSelected = salesSelectedProp && salesSelectedProp.object_id === p.object_id;
                    return `
                    <div class="dropdown-item ${isSelected ? 'selected' : ''}" data-id="${p.object_id}">
                        <span><strong>${p.object_id}</strong> - ${p.adres}, ${p.plaats || ''}</span>
                        <span class="pppw">${pppw}/pppw</span>
                    </div>
                `;
                }).join('');

                // Add click handlers
                dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const id = item.dataset.id;
                        salesSelectedProp = allProperties.find(p => p.object_id === id);
                        document.getElementById('salesPropSearch').value =
                            `${salesSelectedProp.object_id} - ${salesSelectedProp.adres}`;
                        dropdown.classList.remove('open');
                        updateSalesCalc();
                    });
                });
            }

            function updateSalesCalc() {
                if (!salesSelectedProp) {
                    return;
                }

                const p = salesSelectedProp;
                const inhuur = p.inhuur_totaal_excl_btw || 0;
                const verhuurHuidig = p.verhuur_totaal_excl_btw || 0;
                const margeHuidig = p.marge_maand_excl_btw || 0;
                const margeTarget = parseFloat(document.getElementById('calcMargeTarget').value) || 0;
                const capacity = p.capaciteit_personen || 4;
                const weeksPerMonth = SALES_DATA.config?.weken_per_maand || 4.33;
                const gweValue = p.verhuur_voorschot_gwe || p.voorschot_gwe_standaard || 250;

                // Property info with enhanced details
                const inhuurPppw = p.inhuur_pppw ? `â‚¬${p.inhuur_pppw.toFixed(2)}/pppw` : '-';
                const verhuurPppw = p.verhuur_pppw ? `â‚¬${p.verhuur_pppw.toFixed(2)}/pppw` : '-';
                document.getElementById('salesPropInfo').innerHTML = `
                <div class="detail-grid" style="font-size:0.85rem">
                    <div class="detail-item"><span class="label">Type:</span><span class="value">${p.woning_type || '-'}</span></div>
                    <div class="detail-item"><span class="label">Capaciteit:</span><span class="value">${capacity} pers</span></div>
                    <div class="detail-item"><span class="label">Slaapkamers:</span><span class="value">${p.aantal_slaapkamers || '-'}</span></div>
                    <div class="detail-item"><span class="label">Status:</span><span class="value">${p.beschikbaarheid_status || '-'}</span></div>
                    <div class="detail-item"><span class="label">Inhuur PPPW:</span><span class="value" style="color:var(--gray)">${inhuurPppw}</span></div>
                    <div class="detail-item"><span class="label">Verhuur PPPW:</span><span class="value positive">${verhuurPppw}</span></div>
                    <div class="detail-item"><span class="label">GWE/maand:</span><span class="value">â‚¬${gweValue}</span></div>
                    <div class="detail-item"><span class="label">Beschikbaar:</span><span class="value">${p.verhuur_eind || 'Nu'}</span></div>
                </div>
            `;

                // Calculator
                document.getElementById('calcInhuur').textContent = formatMoney(inhuur);

                // Min verhuur = inhuur / (1 - margin%) for true margin calculation
                const minVerhuur = margeTarget >= 100 ? inhuur * 10 : inhuur / (1 - margeTarget / 100);
                document.getElementById('calcMinVerhuur').textContent = formatMoney(minVerhuur);

                // Calculate PPPW services
                let pppwServicesCost = 0;
                let servicesBreakdown = [];

                document.querySelectorAll('#serviceToggles .toggle-btn.active').forEach(btn => {
                    const service = btn.dataset.service;
                    if (service === 'gwe') {
                        pppwServicesCost += gweValue;
                        servicesBreakdown.push({ name: 'ğŸ’¡ GWE', cost: gweValue, type: 'fixed' });
                    } else if (btn.dataset.pppw) {
                        const pppwRate = parseFloat(btn.dataset.pppw) || 0;
                        const monthlyCost = pppwRate * capacity * weeksPerMonth;
                        pppwServicesCost += monthlyCost;
                        servicesBreakdown.push({
                            name: btn.textContent.trim(),
                            pppw: pppwRate,
                            cost: monthlyCost,
                            type: 'pppw'
                        });
                    }
                });

                // Calculate one-time costs
                let onetimeCost = 0;
                document.querySelectorAll('#onetimeToggles .toggle-btn.active').forEach(btn => {
                    if (btn.dataset.onetime) {
                        onetimeCost += parseFloat(btn.dataset.onetime) || 0;
                    }
                });

                // Update services breakdown display
                const breakdownHtml = servicesBreakdown.length > 0
                    ? servicesBreakdown.map(s =>
                        s.type === 'pppw'
                            ? `<div style="display:flex;justify-content:space-between;"><span>${s.name}</span><span>â‚¬${s.pppw}/pppw Ã— ${capacity}p Ã— ${weeksPerMonth.toFixed(2)}w = <strong>${formatMoney(s.cost)}</strong></span></div>`
                            : `<div style="display:flex;justify-content:space-between;"><span>${s.name}</span><span><strong>${formatMoney(s.cost)}</strong>/maand</span></div>`
                    ).join('')
                    : '<span style="color:var(--gray);">Geen services geselecteerd</span>';
                document.getElementById('servicesDetails').innerHTML = breakdownHtml;

                // One-time costs display
                document.getElementById('calcOnetime').textContent = formatMoney(onetimeCost);

                // Total monthly = minVerhuur + PPPW services
                const totalMonthly = minVerhuur + pppwServicesCost;
                document.getElementById('calcTotalAdvice').textContent = formatMoney(totalMonthly);

                // PPPW calculations
                const pppwWithServices = totalMonthly / (capacity * weeksPerMonth);
                const pppwBase = minVerhuur / (capacity * weeksPerMonth);
                document.getElementById('calcPppwWithServices').textContent = `â‚¬${pppwWithServices.toFixed(2)}`;
                document.getElementById('calcPppwBase').textContent = `â‚¬${pppwBase.toFixed(2)}`;

                // Margin bar (visual)
                const marginPct = Math.min(100, Math.max(0, margeTarget));
                document.getElementById('marginFill').style.width = marginPct + '%';

                // ========== SCENARIO COMPARISON ==========
                document.getElementById('calcHuidigeVerhuur').textContent = formatMoney(verhuurHuidig);
                document.getElementById('calcInhuurRef').textContent = formatMoney(inhuur);
                document.getElementById('calcInhuurRef2').textContent = formatMoney(inhuur);
                document.getElementById('calcHuidigeMarge').textContent = formatMoney(margeHuidig);

                // Huidige margin % = marge / verhuur (not inhuur)
                const huidigeMargePct = verhuurHuidig > 0 ? ((margeHuidig / verhuurHuidig) * 100) : 0;
                document.getElementById('calcHuidigeMargePct').textContent = huidigeMargePct.toFixed(1) + '%';
                document.getElementById('calcHuidigeMargePct').className = huidigeMargePct >= 0 ? 'positive' : 'negative';

                // Huidige PPPW
                const huidigePppw = capacity > 0 ? verhuurHuidig / (capacity * weeksPerMonth) : 0;
                document.getElementById('calcHuidigePppw').textContent = `â‚¬${huidigePppw.toFixed(2)}`;

                // Nieuwe scenario
                const nieuweVerhuur = parseFloat(document.getElementById('calcNieuweVerhuur').value) || 0;
                const nieuweMarge = nieuweVerhuur - inhuur;
                const nieuweMargePct = nieuweVerhuur > 0 ? ((nieuweMarge / nieuweVerhuur) * 100) : 0;
                const nieuwePppw = capacity > 0 ? nieuweVerhuur / (capacity * weeksPerMonth) : 0;
                const verschil = nieuweMarge - margeHuidig;

                document.getElementById('calcNieuweMarge').textContent = formatMoney(nieuweMarge);
                document.getElementById('calcNieuweMarge').className = nieuweMarge >= 0 ? 'positive' : 'negative';

                document.getElementById('calcNieuweMargePct').textContent = nieuweMargePct.toFixed(1) + '%';
                document.getElementById('calcNieuweMargePct').className = nieuweMargePct >= 0 ? 'positive' : 'negative';

                document.getElementById('calcNieuwePppw').textContent = `â‚¬${nieuwePppw.toFixed(2)}`;
                document.getElementById('calcNieuwePppw').className = nieuwePppw >= huidigePppw ? 'positive' : 'negative';

                document.getElementById('calcVerschil').textContent = (verschil >= 0 ? '+' : '') + formatMoney(verschil);
                document.getElementById('calcVerschil').className = 'value ' + (verschil >= 0 ? 'positive' : 'negative');

                document.getElementById('calcVerschilJaar').textContent = (verschil >= 0 ? '+' : '') + formatMoney(verschil * 12);
                document.getElementById('calcVerschilJaar').className = 'value ' + (verschil >= 0 ? 'positive' : 'negative');

                // Quick info with enhanced PPPW
                const inhuurPppwQ = p.inhuur_pppw ? `â‚¬${p.inhuur_pppw.toFixed(2)}` : '-';
                const verhuurPppwQ = p.verhuur_pppw ? `â‚¬${p.verhuur_pppw.toFixed(2)}` : '-';
                document.getElementById('quickInfo').innerHTML = `
                <div style="font-size:0.85rem">
                    <p><strong>ğŸ‘¤ Eigenaar:</strong> ${p.eigenaar_naam || 'Onbekend'}</p>
                    <p style="color:var(--gray)">${p.eigenaar_telefoon || ''} | ${p.eigenaar_email || ''}</p>
                    <hr style="margin:0.5rem 0; border:none; border-top:1px solid #eee">
                    <p><strong>ğŸ‘¥ Huurder:</strong> ${p.huurder_naam || 'Leeg'}</p>
                    <p style="color:var(--gray)">${p.huurder_telefoon || ''} | ${p.huurder_email || ''}</p>
                    <hr style="margin:0.5rem 0; border:none; border-top:1px solid #eee">
                    <p><strong>ğŸ’° PPPW:</strong> <span style="color:var(--gray)">Inhuur ${inhuurPppwQ}</span> â†’ <span style="color:var(--success); font-weight:600">Verhuur ${verhuurPppwQ}</span></p>
                    <p><strong>ğŸ“… Contract:</strong> ${p.verhuur_start || '-'} â†’ ${p.verhuur_eind || '-'}</p>
                </div>
            `;
            }

            // ========== CONTRACT OUTPUT ==========
            function generateContractOutput() {
                if (!salesSelectedProp) {
                    alert('Selecteer eerst een woning');
                    return;
                }

                const p = salesSelectedProp;
                const startDate = document.getElementById('contractStartDate').value;
                const duration = parseInt(document.getElementById('contractDuration').value) || 12;
                const totalAdvice = document.getElementById('calcTotalAdvice').textContent;
                const pppwWithServices = document.getElementById('calcPppwWithServices').textContent;
                const pppwBase = document.getElementById('calcPppwBase').textContent;
                const onetimeCost = document.getElementById('calcOnetime').textContent;
                const capacity = p.capaciteit_personen || 4;

                // Get selected services
                const selectedServices = [];
                document.querySelectorAll('#serviceToggles .toggle-btn.active, #onetimeToggles .toggle-btn.active').forEach(btn => {
                    selectedServices.push(btn.textContent.trim());
                });

                const output = `
                <h4 style="margin-bottom:0.5rem;">ğŸ“‹ Contract Gegevens</h4>
                <table style="width:100%; border-collapse:collapse;">
                    <tr><td style="padding:0.25rem 0; border-bottom:1px solid #eee;"><strong>Object</strong></td><td>${p.object_id} - ${p.adres}</td></tr>
                    <tr><td style="padding:0.25rem 0; border-bottom:1px solid #eee;"><strong>Plaats</strong></td><td>${p.plaats || '-'}</td></tr>
                    <tr><td style="padding:0.25rem 0; border-bottom:1px solid #eee;"><strong>Capaciteit</strong></td><td>${capacity} personen</td></tr>
                    <tr><td style="padding:0.25rem 0; border-bottom:1px solid #eee;"><strong>Startdatum</strong></td><td>${startDate || 'Niet ingevuld'}</td></tr>
                    <tr><td style="padding:0.25rem 0; border-bottom:1px solid #eee;"><strong>Looptijd</strong></td><td>${duration} maanden</td></tr>
                    <tr><td style="padding:0.25rem 0; border-bottom:1px solid #eee;"><strong>Huur/maand</strong></td><td>${totalAdvice}</td></tr>
                    <tr><td style="padding:0.25rem 0; border-bottom:1px solid #eee;"><strong>PPPW (incl. services)</strong></td><td>${pppwWithServices}</td></tr>
                    <tr><td style="padding:0.25rem 0; border-bottom:1px solid #eee;"><strong>PPPW (kaal)</strong></td><td>${pppwBase}</td></tr>
                    <tr><td style="padding:0.25rem 0; border-bottom:1px solid #eee;"><strong>Eenmalige kosten</strong></td><td>${onetimeCost}</td></tr>
                    <tr><td style="padding:0.25rem 0;"><strong>Services</strong></td><td>${selectedServices.join(', ') || 'Geen'}</td></tr>
                </table>
                <button onclick="copyContractData()" style="margin-top:0.75rem; padding:0.5rem 1rem; background:#667eea; color:white; border:none; border-radius:var(--radius); cursor:pointer;">ğŸ“‹ Kopieer naar klembord</button>
            `;

                document.getElementById('contractOutput').innerHTML = output;
                document.getElementById('contractOutput').style.display = 'block';
            }

            function copyContractData() {
                const p = salesSelectedProp;
                const startDate = document.getElementById('contractStartDate').value;
                const duration = document.getElementById('contractDuration').value;
                const totalAdvice = document.getElementById('calcTotalAdvice').textContent;
                const pppwWithServices = document.getElementById('calcPppwWithServices').textContent;

                const selectedServices = [];
                document.querySelectorAll('#serviceToggles .toggle-btn.active, #onetimeToggles .toggle-btn.active').forEach(btn => {
                    selectedServices.push(btn.textContent.trim());
                });

                const text = `CONTRACT GEGEVENS
Object: ${p.object_id} - ${p.adres}, ${p.plaats}
Capaciteit: ${p.capaciteit_personen} personen
Startdatum: ${startDate}
Looptijd: ${duration} maanden
Huur/maand: ${totalAdvice}
PPPW: ${pppwWithServices}
Services: ${selectedServices.join(', ')}`;

                navigator.clipboard.writeText(text).then(() => {
                    alert('Contract data gekopieerd naar klembord!');
                });
            }

            // ========== BUDGET MATCHER WITH DISTANCE ==========

            // Dutch city center coordinates (fallback for distance calc)
            const CITY_COORDS = {
                'Rotterdam': { lat: 51.9225, lng: 4.4792 },
                'Den Haag': { lat: 52.0705, lng: 4.3007 },
                'Amsterdam': { lat: 52.3676, lng: 4.9041 },
                'Utrecht': { lat: 52.0893, lng: 5.1101 },
                'Leiden': { lat: 52.1601, lng: 4.4970 },
                'Delft': { lat: 52.0116, lng: 4.3571 },
                'Dordrecht': { lat: 51.8133, lng: 4.6901 },
                'Schiedam': { lat: 51.9194, lng: 4.3997 },
                'Vlaardingen': { lat: 51.9117, lng: 4.3419 },
                'Capelle aan den IJssel': { lat: 51.9292, lng: 4.5783 },
                'Spijkenisse': { lat: 51.8450, lng: 4.3292 },
                'Hoogvliet': { lat: 51.8625, lng: 4.3558 },
                'Zoetermeer': { lat: 52.0575, lng: 4.4931 },
                'Alphen aan den Rijn': { lat: 52.1292, lng: 4.6578 },
                'Gouda': { lat: 52.0175, lng: 4.7056 },
                'Hoek van Holland': { lat: 51.9792, lng: 4.1333 },
                'Heerlen': { lat: 50.8833, lng: 5.9833 },
                'Maastricht': { lat: 50.8514, lng: 5.6900 },
                'Eindhoven': { lat: 51.4416, lng: 5.4697 },
                'Tilburg': { lat: 51.5555, lng: 5.0913 },
                'Breda': { lat: 51.5719, lng: 4.7683 },
            };

            // Haversine formula for distance in km
            function haversineDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Earth's radius in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            // Geocode postcode using Nominatim (async)
            async function geocodePostcode(postcode) {
                const cleanPostcode = postcode.replace(/\s/g, '').toUpperCase();
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(cleanPostcode + ', Netherlands')}&format=json&limit=1&countrycodes=nl`;

                try {
                    const response = await fetch(url, {
                        headers: { 'User-Agent': 'RyanRent-Dashboard/1.0' }
                    });
                    const data = await response.json();
                    if (data && data.length > 0) {
                        return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                    }
                } catch (e) {
                    console.error('Geocoding failed:', e);
                }
                return null;
            }

            // Get property coordinates (from city lookup)
            function getPropertyCoords(property) {
                // First try city lookup
                if (property.plaats && CITY_COORDS[property.plaats]) {
                    return CITY_COORDS[property.plaats];
                }
                // Fallback to Rotterdam center
                return CITY_COORDS['Rotterdam'];
            }

            async function runBudgetMatcher() {
                const targetPostcode = document.getElementById('targetPostcode').value.trim();
                const maxDistance = parseFloat(document.getElementById('maxDistance').value) || 999;
                const minBudget = parseFloat(document.getElementById('budgetMin').value) || 0;
                const maxBudget = parseFloat(document.getElementById('budgetMax').value) || 999999;
                const minRooms = parseInt(document.getElementById('budgetRooms').value) || 0;
                const cityFilter = document.getElementById('budgetCity').value;
                const availableWithinWeeks = parseInt(document.getElementById('availableWithin').value) || 0;

                const statusDiv = document.getElementById('matcherStatus');
                const resultsDiv = document.getElementById('matcherResults');

                // Geocode target postcode if provided
                let targetCoords = null;
                let filterInfo = [];

                if (cityFilter) {
                    filterInfo.push(`ğŸ™ï¸ ${cityFilter}`);
                }

                if (availableWithinWeeks === 0) {
                    filterInfo.push('ğŸ  Nu vrij');
                } else {
                    filterInfo.push(`ğŸ“… ${availableWithinWeeks}w`);
                }

                if (targetPostcode) {
                    statusDiv.textContent = 'ğŸ“ Locatie opzoeken...';
                    targetCoords = await geocodePostcode(targetPostcode);
                    if (!targetCoords) {
                        statusDiv.textContent = 'âš ï¸ Postcode niet gevonden';
                    } else {
                        filterInfo.push(`ğŸ“ ${maxDistance}km`);
                    }
                }

                statusDiv.textContent = filterInfo.length > 0 ? `Filters: ${filterInfo.join(' + ')}` : '';

                // Calculate availability cutoff date
                const today = new Date();
                const cutoffDate = new Date(today);
                cutoffDate.setDate(cutoffDate.getDate() + (availableWithinWeeks * 7));

                // Filter properties
                let matches = allProperties.filter(p => {
                    const pppw = p.verhuur_pppw || 0;
                    const rooms = p.aantal_slaapkamers || 0;
                    const matchCity = !cityFilter || p.plaats === cityFilter;
                    const matchRooms = rooms >= minRooms;
                    const nearBudget = pppw >= (minBudget * 0.8) && pppw <= (maxBudget * 1.2);

                    // Check availability
                    let isAvailable = false;
                    if (p.beschikbaarheid_status === 'Beschikbaar' || p.beschikbaarheid_status === 'Leegstand') {
                        isAvailable = true;
                    } else if (p.verhuur_eind && availableWithinWeeks > 0) {
                        // Check if contract ends within the timeframe
                        const endDate = new Date(p.verhuur_eind);
                        isAvailable = endDate <= cutoffDate;
                    }

                    return matchCity && matchRooms && nearBudget && pppw > 0 && isAvailable;
                });

                // Calculate distances if we have target coordinates
                if (targetCoords) {
                    matches = matches.map(p => {
                        const propCoords = getPropertyCoords(p);
                        const distance = haversineDistance(
                            targetCoords.lat, targetCoords.lng,
                            propCoords.lat, propCoords.lng
                        );
                        return { ...p, _distance: distance };
                    }).filter(p => p._distance <= maxDistance);

                    // Sort by distance first, then by in-budget
                    matches.sort((a, b) => {
                        const aInBudget = a.verhuur_pppw >= minBudget && a.verhuur_pppw <= maxBudget;
                        const bInBudget = b.verhuur_pppw >= minBudget && b.verhuur_pppw <= maxBudget;
                        // Prioritize in-budget, then sort by distance
                        if (aInBudget !== bInBudget) return bInBudget - aInBudget;
                        return a._distance - b._distance;
                    });
                } else {
                    // No distance: sort by budget fit
                    matches.sort((a, b) => {
                        const aInBudget = a.verhuur_pppw >= minBudget && a.verhuur_pppw <= maxBudget;
                        const bInBudget = b.verhuur_pppw >= minBudget && b.verhuur_pppw <= maxBudget;
                        if (aInBudget && !bInBudget) return -1;
                        if (!aInBudget && bInBudget) return 1;
                        return a.verhuur_pppw - b.verhuur_pppw;
                    });
                }

                if (matches.length === 0) {
                    resultsDiv.innerHTML = `<p style="color: var(--gray); text-align: center;">Geen woningen gevonden</p>`;
                    return;
                }

                resultsDiv.innerHTML = `<p style="margin-bottom:0.5rem; color:var(--gray); font-size:0.8rem;">${matches.length} woningen gevonden</p>` +
                    matches.map(p => {
                        const pppw = p.verhuur_pppw.toFixed(0);
                        const inBudget = p.verhuur_pppw >= minBudget && p.verhuur_pppw <= maxBudget;
                        const distanceText = p._distance !== undefined ? `${p._distance.toFixed(1)} km` : '';
                        return `
                        <div class="matcher-item ${inBudget ? 'in-budget' : ''}" onclick="selectMatcherProperty('${p.object_id}')">
                            <div class="info">
                                <div class="addr">${p.object_id} - ${p.adres}</div>
                                <div class="meta">${p.plaats || ''} ${distanceText ? '| ğŸ“ ' + distanceText : ''} | ${p.aantal_slaapkamers || '?'} slaapk. | ${p.capaciteit_personen || '?'} pers</div>
                            </div>
                            <div class="pppw-badge">â‚¬${pppw}</div>
                        </div>
                    `;
                    }).join('');
            }

            function selectMatcherProperty(objectId) {
                salesSelectedProp = allProperties.find(p => p.object_id === objectId);
                if (salesSelectedProp) {
                    document.getElementById('salesPropSearch').value =
                        `${salesSelectedProp.object_id} - ${salesSelectedProp.adres}`;
                    updateSalesCalc();
                    // Scroll to top of sales prep
                    document.getElementById('panel-salesprep').scrollTo({ top: 0, behavior: 'smooth' });
                }
            }

            // Initialize on DOM load
            document.addEventListener('DOMContentLoaded', function () {
                setTimeout(initSalesPrep, 100);
            });
        </script>
</body>

</html>